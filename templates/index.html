<!doctype html>

<head>
  <style>
    body {
      margin-left: 5%;
      margin-right: 5%;
    }
    #scroller { margin-bottom: 5%; }
    .input {
      border: 1px solid #aaaaaa;
      border-radius: 0.75em;
      padding: 0.5em;
      font-family: monospace;
    }
    .output {
      font-family: monospace;
      padding: 0.5em;
    }
    /* https://css-tricks.com/books/greatest-css-tricks/pin-scrolling-to-bottom/ */
    #scroller * { overflow-anchor: none; }
    #anchor { overflow-anchor: auto; height: 1px; }
  </style>
  <script>
    let history = [];
    let history_cursor = 0;
    const inputkeydown = (event) => {
      let input = document.getElementById('input');
      console.log(event.key);
      switch (event.key) {
        case 'ArrowUp': {
          history_cursor = Math.max(0, history_cursor - 1);
          if (history_cursor < history.length)
            input.innerHTML = history[history_cursor];
        } break;
        case 'ArrowDown': {
          history_cursor = Math.min(history.length, history_cursor + 1);
          if (history_cursor < history.length)
            input.innerHTML = history[history_cursor];
        } break;
        case 'Enter': {
          let command = input.innerHTML;
          history.push(command);
          history_cursor = history.length;
          fetch('input', {
            method: 'POST',
            headers: {'Accept': 'application/json', 'Content-Type': 'application/json'},
            body: command,
          }).then(v => {
            console.log('Got response', v);
            (async () => {
              let log = document.getElementById('log');
              let html = '';
              for await (const chunk of v.body)
                html += new TextDecoder().decode(chunk);
              console.log('Prepending', html, 'to output');
              let commandDiv = document.createElement('div');
              commandDiv.innerHTML = command;
              commandDiv.className = 'input';
              let outputDiv = document.createElement('div');
              outputDiv.innerHTML += html;
              outputDiv.className += 'output';
              log.appendChild(commandDiv);
              log.appendChild(outputDiv);
            })();
          });
          input.innerHTML = '';
          return event.preventDefault();
        } break;
        default: break;
      }
    }
  </script>
</head>
<body>
  <div id="scroller">
    <div id="padding" style="height:100vh"></div>
    <div id="log"></div>
    <div contenteditable autofocus id="input" class="input" onkeydown="inputkeydown(event)"></div>
    <div id="anchor"></div>
  </div>
  <script>window.scrollTo(0, document.body.scrollHeight);</script>
</body>